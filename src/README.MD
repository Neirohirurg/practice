### Описание SQL-запросов и анализа данных  

#### **Задание 1**  
**Анализ связей между таблицами "Лицевые счета" и "НСальдо"**  
1. **Соединение данных**:  
   - Таблица **НСальдо (NS)** содержит данные о сальдо (остатках) на счетах.  
   - Таблица **Лицевые счета (LS)** используется для сопоставления сальдо с конкретными лицевыми счетами.  
   - Таблица **Организации (O)** связывается с поставщиком по идентификатору.  

2. **Фильтрация данных**:  
   - Дата расчета и дата долга должны быть **"2024-10-01"**.  
   - В выборку включаются только положительные суммы.  
   - Данные отбираются только для организации с ИНН **3444259579**.  

3. **Агрегирование**:  
   - Расчет **общей суммы сальдо** по каждому лицевому счету.  

4. **Вывод**:  
   - **Номер лицевого счета**  
   - **Общая сумма НСальдо**  
   - **Классификация организации по ИНН** ("КТ" или "КВ").  

```rb
SELECT 
   LS.Номер as "Номер",
   ROUND(SUM(NS.[Сумма]), 2) as "Сумма",
   CASE 
      WHEN O.ИНН = '3444259579' THEN 'КТ'
      WHEN O.ИНН = '3460019060' THEN 'КВ'
   END AS 'Наименование'
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
WHERE
   NS.[Месяц расчета] = '2024-10-01'
   AND NS.[Месяц долга] = '2024-10-01'
   AND NS.[Сумма] > 0
   AND O.ИНН ='3444259579'
GROUP BY 
   LS.Номер,
   O.ИНН
ORDER BY 
   LS.Номер
```
---
 
#### **Задание 2**  
**Анализ связей между таблицами "Организации" и "Категории организаций"**  
1. **Соединение данных**:  
   - Связь между **НСальдо (NS)**, **Лицевыми счетами (LS)** и **Организациями (O)**.  
   - Организации дополнительно фильтруются по категории через **Категории организаций (KO)**.  

2. **Фильтрация данных**:  
   - Дата расчета и дата долга = **"2024-10-01"**.  
   - Отбор только **положительных сумм**.  
   - Фильтр по ИНН **3444259579** и категории **7036**.  

3. **Агрегирование**:  
   - Расчет **общей суммы сальдо** по каждому лицевому счету.  

4. **Вывод**:  
   - **Номер лицевого счета**  
   - **Общая сумма НСальдо**  
   - **Наименование организации**  

```rb
SELECT 
   LS.Номер as "Номер", 
   ROUND(SUM(NS.[Сумма]), 2) as "Сумма",
   O.Наименование
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
WHERE 
   NS.[Месяц расчета] = '2024-10-01' 
   AND NS.[Месяц долга] = '2024-10-01'
   AND NS.[Сумма] > 0
   AND O.ИНН ='3444259579'
   AND O.ROW_ID IN (
         SELECT KO.[Категории-Организация] 
         FROM [Категории организаций] KO 
         WHERE 
            KO.[Категории организаций] = 7036
   )
GROUP BY 
   LS.Номер, 
   O.Наименование
ORDER BY
   LS.Номер
```
---
 
#### **Задание 3**  
**Анализ связей между "Лицевыми счетами" и "Карточками регистрации"**  
1. **Соединение данных**:  
   - Таблица **Карточки регистрации (KR)** добавляет данные о нанимателе счета (ФИО, дата рождения/смерти).  
   - Фильтрация организаций по категориям **7036, 7034**.  

2. **Фильтрация данных**:  
   - Дата расчета = **"2024-10-01"**.  
   - Дата долга **не ранее "2024-10-01"**.  
   - Только положительные суммы.  

3. **Агрегирование**:  
   - Подсчет **общей суммы сальдо** для каждого лицевого счета.  

4. **Вывод**:  
   - **Сумма НСальдо**  
   - **Номер лицевого счета**  
   - **Счет нанимателя**  
   - **Месяц долга**  
   - **Наименование организации**  
   - **ФИО, дата рождения, дата смерти нанимателя**  

```rb
SELECT 
   ROUND(SUM(NS.[Сумма]), 2) as "Сумма",
   LS.Номер,
   KR.[Счет-Наниматель],
   NS.[Месяц долга],
   O.Наименование,
   O.ROW_ID,
   KR.ФИО,
   KR.[Дата рождения],
   KR.[Дата смерти]
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
WHERE 
   NS.[Месяц расчета] = '2024-10-01' AND NS.[Месяц долга] >= '2024-10-01' 
   AND NS.[Сумма] > 0
   AND O.ИНН ='3444259579' 
   AND O.ROW_ID IN (
         SELECT KO.[Категории-Организация] 
         FROM [Категории организаций] KO 
         WHERE 
            KO.[Категории организаций] IN (7036, 7034)
   )
GROUP BY 
   LS.Номер, 
   KR.[Счет-Наниматель],
   NS.[Месяц долга],
   O.Наименование, 
   O.ROW_ID,
   KR.ФИО, 
   KR.[Дата рождения], 
   KR.[Дата смерти]
```
---
 
#### **Задание 4**  
**Анализ связей в таблице "Взыскания задолженностей"**  
1. **Соединение данных**:  
   - Взыскания (VZ) связываются с состояниями (SD), фазами (VF) и их состояниями (SF).  
   - Держатели долга (DD) связываются с организациями (O).  

2. **Фильтрация данных**:  
   - Только организации с **ИНН = 3444259579**.  
   - Только категории **7036, 7034**.  

3. **Группировка и агрегация**:  
   - Данные группируются по номеру взыскания.  

4. **Вывод**:  
   - **Номер взыскания**  
   - **Название фазы**  
   - **Имя состояния фазы**  
   - **Счет взыскания**  
   - **Дата начала и конца долга**  

```rb
SELECT 
   VZ.ROW_ID as 'ROW_ID_Взыскания',
   VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние',
   VZ.[Счет-Взыскания],
   VZ.ДатНачДолга,
   VZ.ДатКнцДолга
FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
WHERE  
   O.ИНН ='3444259579'
   AND O.ROW_ID IN (
         SELECT 
            KO.[Категории-Организация] 
         FROM [Категории организаций] KO 
         WHERE 
            KO.[Категории организаций] IN (7036, 7034)
   )
GROUP BY 
   VZ.ROW_ID,
   VZ.Номер, 
   VF.Название, 
   SF.Имя,  
   VZ.[Счет-Взыскания],
   VZ.ДатНачДолга, 
   VZ.ДатКнцДолга
```
---
 
#### **Задание 5**  
**Объединение таблиц "НСальдо" и "Взыскание задолженностей" разными способами**  
1. **Через временные таблицы (#temp)**  
   - Создается временная таблица для взысканий (VZ).  
   - К ней добавляются данные из НСальдо и лицевых счетов.  
   - Используется в основном запросе для отбора данных. 

```rb
drop table if EXISTS #temp
SELECT 
   DF.*, 
   VZ.ROW_ID as 'ROW_ID_Взыскания', 
   VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние' 
into #temp
FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
JOIN (
   SELECT 
      ROUND(SUM(NS.[Сумма]), 2) as "Сумма", 
      LS.Номер as 'Номер ЛЦ',
      KR.[Счет-Наниматель], 
      NS.[Месяц долга],
      O.Наименование, O.ROW_ID as 'ROW_ID_Организации',
      KR.ФИО,
      KR.[Дата рождения],
      KR.[Дата смерти]
   FROM [НСальдо] NS
   JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
   JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
   JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
   WHERE 
      NS.[Месяц расчета] = '2024-10-01'
      AND NS.[Месяц долга] >= '2024-10-01' 
      AND NS.[Сумма] > 0
      AND O.ИНН ='3444259579'
      AND O.ROW_ID IN (
            SELECT KO.[Категории Организаций] 
            FROM [Категории организаций] KO 
            WHERE
               KO.[Категории организаций] = 7034
      )
   GROUP BY 
      LS.Номер, 
      KR.[Счет-Наниматель], 
      NS.[Месяц долга], 
      O.Наименование, 
      O.ROW_ID, KR.ФИО,
      KR.[Дата рождения], 
      KR.[Дата смерти]
) AS DF ON DF.[Счет-Наниматель] = VZ.[Счет-Взыскания]
WHERE 
   O.ИНН ='3444259579'
   AND O.ROW_ID IN (
      SELECT 
         KO.[Категории Организаций] 
      FROM [Категории организаций] KO 
      WHERE 
         KO.[Категории организаций] IN (7034)
   )
   AND VF.Название = 'Рассмотрение (абонентский отдел)'
```

2. **Через конструкцию WITH AS**  
   - Используется CTE (Common Table Expression) **DF**, куда предварительно записываются данные из НСальдо.  
   - Затем выполняется основной запрос с присоединением к таблице взысканий (VZ).  

```rb
WITH DF AS (
   SELECT 
      ROUND(SUM(NS.[Сумма]), 2) as "Сумма", 
      LS.Номер,
      KR.[Счет-Наниматель],
      NS.[Месяц долга], 
      O.Наименование,
      O.ROW_ID as "Код организации",
      KR.ФИО,
      KR.[Дата рождения],
      KR.[Дата смерти]
   FROM [НСальдо] NS
   JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
   JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
   JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
   WHERE
      NS.[Месяц расчета] = '2024-10-01'
      AND NS.[Месяц долга] >= '2024-10-01'
      AND NS.[Сумма] > 0
      AND O.ИНН ='3444259579'
      AND O.ROW_ID IN (
         SELECT 
            KO.[Категории-Организация] 
         FROM [Категории организаций] KO 
         WHERE 
            KO.[Категории организаций] IN (7036, 7034)
      )
   GROUP BY 
      LS.Номер, 
      KR.[Счет-Наниматель], 
      NS.[Месяц долга], 
      O.Наименование, 
      O.ROW_ID, KR.ФИО,
      KR.[Дата рождения],
      KR.[Дата смерти]
)

SELECT 
   DF.*, 
   VZ.ROW_ID, 
   VZ.Номер, 
   CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние' 
FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
JOIN DF ON DF.[Счет-Наниматель] = VZ.[Счет-Взыскания]
WHERE 
   O.ИНН ='3444259579'
   AND O.ROW_ID IN (
      SELECT KO.[Категории-Организация] 
      FROM [Категории организаций] KO 
      WHERE 
         KO.[Категории организаций] IN (7036, 7034)
   )
   AND VF.Название = 'Рассмотрение (абонентский отдел)'
```

3. **Через оператор JOIN**  
   - Запрос сразу объединяет данные из НСальдо и Взысканий через **LEFT JOIN**.  

```rb
SELECT 
   ROUND(SUM(NS.[Сумма]), 2) as "Сумма",
   LS.Номер as 'Номер ЛЦ', 
   KR.[Счет-Наниматель],
   NS.[Месяц долга], 
   O.Наименование, 
   O.ROW_ID as 'ROW_ID_Организации',
   KR.ФИО, 
   KR.[Дата рождения],
   KR.[Дата смерти]
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
LEFT JOIN (
    SELECT 
      VZ.ROW_ID as 'ROW_ID_Взыскания', 
      VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние',
      VZ.[Счет-Взыскания]
    FROM [Взыскание задолженности] VZ
    JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
    JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
    LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
    JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
    JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
    WHERE 
      O.ИНН ='3444259579'
       AND O.ROW_ID IN (
         SELECT 
            KO.[Категории-Организация] 
         FROM [Категории организаций] KO 
         WHERE 
            KO.[Категории организаций] IN (7036, 7034)
      )
) AS VZ ON Счет = VZ.[Счет-Взыскания]
WHERE 
   NS.[Месяц расчета] = '2024-10-01' 
   AND NS.[Месяц долга] >= '2024-10-01' 
   AND NS.[Сумма] > 0
   AND O.ИНН ='3444259579'
   AND O.ROW_ID IN (
      SELECT KO.[Категории-Организация] 
      FROM [Категории организаций] KO 
      WHERE 
         KO.[Категории организаций] IN (7036, 7034)
   )
GROUP BY 
   LS.Номер, 
   KR.[Счет-Наниматель],
   NS.[Месяц долга],
   O.Наименование,
   O.ROW_ID,
   KR.ФИО, 
   KR.[Дата рождения],
   KR.[Дата смерти]
```

4. **Вывод**:  
   - **Сумма НСальдо**  
   - **Номер лицевого счета**  
   - **Счет нанимателя**  
   - **Месяц долга**  
   - **Наименование организации**  
   - **ФИО, дата рождения, дата смерти**  
   - **Номер взыскания и его статус**  

---
 
#### **Задание 6**  
**Анализ связей между реестрами и лицевыми счетами**  

1. **Сопоставление данных**:  
   - Лицевые счета связываются с **Реестрами (R)** по номеру счета.  
   - Отбираются организации, соответствующие заданным категориям.  

2. **Выборки по типам реестров**:  
   - **Мунжилье**:  
     - Учитываются только записи в реестре **35700042**.  
     - Фильтр по организациям категории **7036**.  
   - **Цессии**:  
     - Выбираются организации **7034**.  
   - **Остальные счета**:  
     - Исключаются счета, не присутствующие в реестре **35700042**.  

3. **Обогащение данных**:  
   - Создаются временные таблицы с задолженностями (`#tempNS`) и взысканиями (`#tempVZ`).  
   - Данные объединяются с учетом дат задолженности и фаз взыскания.  

4. **Финальный вывод**:  
   - Итоговая таблица содержит информацию о счетах, задолженностях, взысканиях и фазах их обработки.
-- Мунжилье 
```rb
SELECT T.* 
FROM #temp T
JOIN [Категории организаций] KO ON KO.[Категории-Организация] = T.ROW_ID_Организации
JOIN Реестры R ON T.[Номер ЛЦ] = R.[Реестры_состав-Лицевой]
WHERE 
    KO.[Категории организаций] = 7036
    AND R.Папки = 35700042;
```
   - *Цессии*
```rb
SELECT T.* 
FROM #temp T
JOIN [Категории организаций] KO ON KO.[Категории-Организация] = T.ROW_ID_Организации
WHERE 
    KO.[Категории организаций] = 7034
```
   - *Остальное*
```rb
SELECT T.* 
FROM #temp T
JOIN [Категории организаций] KO ON KO.[Категории-Организация] = T.ROW_ID_Организации
WHERE 
    KO.[Категории организаций] = 7036
    AND T.[Счет-Наниматель] NOT IN (
        SELECT R.[Реестры_состав-Лицевой] 
        FROM Реестры R 
        WHERE R.Папки = 35700042
    );
```

```rb
SELECT T.* 
FROM #temp T
JOIN [Категории организаций] KO ON KO.[Категории-Организация] = T.ROW_ID_Организации
WHERE 
   KO.[Категории организаций] = 7036
   AND T.[Счет-Наниматель] NOT IN (
      SELECT 
         R.[Реестры_состав-Лицевой] 
      FROM Реестры R 
      WHERE 
         R.Папки = 35700042
   );
```

```rb
drop table if EXISTS #tempVZ

SELECT 
   VZ.ROW_ID as 'ROW_ID_Взыскания',
   VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние', 
   VZ.[Счет-Взыскания], 
   VZ.ДатНачДолга,
   VZ.ДатКнцДолга
INTO #tempVZ
FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
WHERE  
   O.ИНН ='3444259579'
   AND O.ROW_ID IN (
      SELECT 
         KO.[Категории-Организация] 
      FROM [Категории организаций] KO 
      WHERE 
         KO.[Категории организаций] IN (7036, 7034)
   )
GROUP BY 
   VZ.ROW_ID, 
   VZ.Номер, 
   VF.Название, 
   SF.Имя,  
   VZ.[Счет-Взыскания], 
   VZ.ДатНачДолга, 
   VZ.ДатКнцДолга

drop table if EXISTS #tempNS

SELECT 
   ROUND(SUM(NS.[Сумма]), 2) as "Сумма", 
   LS.Номер as 'Номер ЛЦ',
   KR.[Счет-Наниматель],
   NS.[Месяц долга], 
   O.Наименование,
   O.ROW_ID as 'ROW_ID_Организации', 
   KR.ФИО, 
   KR.[Дата рождения], 
   KR.[Дата смерти]
INTO #tempNS
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
WHERE 
   NS.[Месяц расчета] = '2024-10-01' 
   AND NS.[Месяц долга] >= '2024-10-01' 
   AND NS.[Сумма] > 0
   AND O.ИНН ='3444259579'
   AND O.ROW_ID IN (
      SELECT 
         KO.[Категории-Организация] 
      FROM [Категории организаций] KO 
      WHERE 
         KO.[Категории организаций] IN (7036, 7034)
   )
GROUP BY 
   LS.Номер,
   KR.[Счет-Наниматель],
   NS.[Месяц долга], 
   O.Наименование, 
   O.ROW_ID, 
   KR.ФИО, 
   KR.[Дата рождения], 
   KR.[Дата смерти]

SELECT * 
FROM #tempVZ VZ
Right JOIN #tempNS NS ON 
   NS.[Счет-Наниматель] = VZ.[Счет-Взыскания] 
   AND [Месяц долга] BETWEEN Vz.ДатНачДолга AND VZ.ДатКнцДолга
```
---
 
#### **Задание 7**  
**Объединение данных о задолженности и взысканиях**  

1. **Создание временных таблиц**:  
   - `#tempNS` – выборка задолженностей из **НСальдо** (счет, сумма, месяц, организация, наниматель).  
   - `#tempVZ` – выборка взысканий из **Взыскание задолженности** (номер, пени, госпошлина, даты, фаза, документ).  

2. **Объединение данных**:  
   - `#tempSP` – связывание задолженностей и взысканий, расчет пени и госпошлины с учетом фазы взыскания.  

3. **Финальный результат**:  
   - Вывод информации о задолженностях, связанных взысканиях и документах.
```rb
drop table if EXISTS #tempNS

SELECT 
   ROUND(SUM(NS.[Сумма]), 2) as "Сумма",
   LS.Номер as 'Номер ЛЦ', 
   NS.Счет,
   NS.[Месяц долга],
   O.Наименование, O.ROW_ID as 'ROW_ID_Организации', 
   KR.ФИО, 
   KR.[Дата рождения],
   KR.[Дата смерти]
INTO #tempNS
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
JOIN [Карточки регистрации] KR ON KR.ROW_ID = NS.Счет
WHERE 
   NS.[Месяц расчета] = '2025-02-01' 
   AND NS.[Месяц долга] < '2025-02-01' 
   AND NS.[Сумма] > 0
   AND O.ИНН ='3444259579'
   AND O.ROW_ID IN (
      SELECT 
         KO.[Категории-Организация] 
      FROM [Категории организаций] KO 
      WHERE 
         KO.[Категории организаций] IN (7036, 7034)
   )
GROUP BY 
   LS.Номер,
   NS.Счет,
   NS.[Месяц долга], 
   O.Наименование, 
   O.ROW_ID, 
   KR.ФИО, 
   KR.[Дата рождения], 
   KR.[Дата смерти]


drop table if EXISTS #tempVZ

SELECT 
   VZ.Номер, 
   VZ.[Счет-Взыскания], 
   Sd.Сумма2 as 'Пени', 
   SD.ГосПошлина, 
   VZ.ДатНачДолга, 
   VZ.ДатКнцДолга,
   SF.Имя as 'Фаза', 
   SD.НомерДокумента, 
   SD.ROW_ID as 'ROW_ID_Состояния', 
   VZ.ОплатаПени,
   VZ.ОплатаГоспошлины
INTO #tempVZ
FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.[ROW_ID]
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SD.[ПодФаза-Состояние] = SF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
WHERE  
   O.ИНН ='3444259579' 
   AND O.ROW_ID IN (
      SELECT 
         KO.[Категории-Организация] 
      FROM [Категории организаций] KO 
      WHERE 
         KO.[Категории организаций] IN (7036, 7034)
   )
GROUP BY 
   VZ.Номер, 
   VZ.[Счет-Взыскания],  
   SD.ГосПошлина, 
   Sd.Сумма2,
   VZ.ДатНачДолга,
   VZ.ДатКнцДолга, 
   VF.Название, 
   SF.Имя, 
   SD.НомерДокумента, 
   SD.ROW_ID, 
   VZ.ОплатаПени, 
   VZ.ОплатаГоспошлины

drop table if EXISTS #tempSP
SELECT 
   VZ.Номер, 
   VZ.Фаза, 
   VZ.НомерДокумента,
   NS.Счет,
   ROUND(SUM(NS.Сумма), 2) as 'Сумма', 
   CASE VZ.Фаза 
      WHEN 'Подача' 
      THEN ROUND(VZ.Пени - VZ.ОплатаПени, 2) 
      ELSE ROUND(VZ.Пени, 2) END as 'Пени', 
   CASE VZ.Фаза 
      WHEN 'Подача' 
      THEN ROUND(VZ.ГосПошлина - VZ.ОплатаГоспошлины, 2) 
      ELSE ROUND(VZ.ГосПошлина, 2) 
   END as 'ГосПошлина', 
   VZ.ОплатаПени, 
   VZ.ОплатаГоспошлины
INTO #tempSP
FROM #tempVZ VZ
LEFT JOIN #tempNS NS ON 
   NS.Счет = VZ.[Счет-Взыскания] 
   AND [Месяц долга] BETWEEN ДатНачДолга AND ДатКнцДолга
GROUP BY 
   VZ.Номер, 
   VZ.НомерДокумента, 
   VZ.Фаза, 
   VZ.[ROW_ID_Состояния], 
   VZ.Пени, 
   VZ.ГосПошлина, 
   VZ.ОплатаПени,
   VZ.ОплатаГоспошлины, 
   NS.Счет
ORDER BY 
   VZ.Номер


SELECT 
   SP.НомерДокумента as 'Номер ИД',
   SP.Номер, 
   Sp.Счет,
   SP.Сумма, 
   SP.Пени, 
   SP.ГосПошлина
FROM #tempSP SP
WHERE 
   SP.НомерДокумента != ''
ORDER BY 
   SP.НомерДокумента
```
---
 
### **Заключение**  
Этот набор SQL-запросов демонстрирует различные методы анализа данных, объединения таблиц и фильтрации записей в зависимости от заданных условий. Используются **JOIN**, **CTE (WITH AS)**, **временные таблицы (#temp)**, а также **GROUP BY** и **агрегирующие функции** для подсчета общей суммы сальдо. Это обеспечивает гибкость и удобство работы с отчетами и аналитическими выборками.
