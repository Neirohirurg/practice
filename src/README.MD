# Задание 1. 
- Проанализировать связи между таблицами Лицевые счета и Нсальдо
- Отфильтровать данные по дате и ИНН
- Агрегировать данные
- Вывести 
    - Номер Лицевого счета
    - Сумму Нсальдо по всем лицевым счетам
#
```rb
SELECT LS.Номер as "Номер", ROUND(SUM(NS.[Сумма]), 2) as "Сумма",
    CASE 
        WHEN O.ИНН = '3444259579' THEN 'КТ'
        WHEN O.ИНН = '3460019060' THEN 'КВ'
    END AS 'Наименование'
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
WHERE NS.[Месяц расчета] = '2024-10-01' AND NS.[Месяц долга] = '2024-10-01' and NS.[Сумма] > 0
AND O.ИНН ='3444259579'
GROUP BY LS.Номер, O.ИНН
ORDER BY LS.Номер
```

# Задание 2
- Проанализиовать связи между таблицами Организации и Категории организации
- Отфильтровать данные по дате, ИНН и категории организации
- Агрегировать данные
- Вывести 
    - Номер Лицевого счета
    - Сумму Нсальдо
    - Наименование организации 
#
```rb
SELECT LS.Номер as "Номер", ROUND(SUM(NS.[Сумма]), 2) as "Сумма", O.Наименование
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
WHERE NS.[Месяц расчета] = '2024-10-01' AND NS.[Месяц долга] = '2024-10-01' and NS.[Сумма] > 0
AND O.ИНН ='3444259579' AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] = 7036)
GROUP BY LS.Номер, O.Наименование
ORDER BY LS.Номер
```

# Задание 3
- Проанализировать связи между Лицевыми счетами и Карточками регистрации
- Отфильтровать данные по дате, ИНН и категории организации
- Агрегировать данные
- Вывести
    - Сумму Нсальдо
    - Номер Лицевого счета
    - Счет Нанимателя
    - Месяц долга
    - Наименование организации
    - ФИО
    - Дата рождения
    - Дата смерти
#
```rb
SELECT ROUND(SUM(NS.[Сумма]), 2) as "Сумма", LS.Номер, KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID, KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
WHERE NS.[Месяц расчета] = '2024-10-01' AND NS.[Месяц долга] >= '2024-10-01' and NS.[Сумма] > 0
AND O.ИНН ='3444259579' 
AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7036, 7034))
GROUP BY LS.Номер, KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID, KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]
```

# Задание 4
- Проанализировать связи таблицы Взыскания задолжностей
- Отфильтровать данные по ИНН и Категории организации
- Агрегировать данные
- Вывести
    - Номер взыскания
    - Название фазы
    - Имя состояния фазы
    - Счет взыскания
    - Дата начала долга
    - Дата конца долга
#
```rb
SELECT VZ.ROW_ID as 'ROW_ID_Взыскания', VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние', VZ.[Счет-Взыскания], VZ.ДатНачДолга, VZ.ДатКнцДолга
FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
WHERE  O.ИНН ='3444259579'
AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7036, 7034))
GROUP BY VZ.ROW_ID, VZ.Номер, VF.Название, SF.Имя,  VZ.[Счет-Взыскания], VZ.ДатНачДолга, VZ.ДатКнцДолга
```

# Задание 5
- Объеденить таблицы Нсальдо и Взыскание задолжностей 3-мя разными способами
### Через временные таблицы
```rb
drop table if EXISTS #temp
SELECT DF.*, VZ.ROW_ID as 'ROW_ID_Взыскания', VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние' 
into #temp
FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
JOIN (SELECT ROUND(SUM(NS.[Сумма]), 2) as "Сумма", LS.Номер as 'Номер ЛЦ', KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID as 'ROW_ID_Организации', KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]
    FROM [НСальдо] NS
    JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
    JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
    JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
    WHERE NS.[Месяц расчета] = '2024-10-01' AND NS.[Месяц долга] >= '2024-10-01' and NS.[Сумма] > 0
    AND O.ИНН ='3444259579'
    AND O.ROW_ID IN (SELECT KO.[Категории Организаций] FROM [Категории организаций] KO WHERE KO.[Категории организаций] = 7034)
    GROUP BY LS.Номер, KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID, KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]) AS DF ON DF.[Счет-Наниматель] = VZ.[Счет-Взыскания]
WHERE O.ИНН ='3444259579'
AND O.ROW_ID IN (SELECT KO.[Категории Организаций] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7034))
AND VF.Название = 'Рассмотрение (абонентский отдел)'
```
### Через конструкцию WITH AS
```rb
WITH DF AS (
    SELECT ROUND(SUM(NS.[Сумма]), 2) as "Сумма", LS.Номер, KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID as "Код организации", KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]
    FROM [НСальдо] NS
    JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
    JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
    JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
    WHERE NS.[Месяц расчета] = '2024-10-01' AND NS.[Месяц долга] >= '2024-10-01' and NS.[Сумма] > 0
    AND O.ИНН ='3444259579'
    AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7036, 7034))
    GROUP BY LS.Номер, KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID, KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]
)

SELECT DF.*, VZ.ROW_ID, VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние' FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
JOIN DF ON DF.[Счет-Наниматель] = VZ.[Счет-Взыскания]
WHERE O.ИНН ='3444259579'
AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7036, 7034))
AND VF.Название = 'Рассмотрение (абонентский отдел)'
```
### Через оператор JOIN
```rb
SELECT ROUND(SUM(NS.[Сумма]), 2) as "Сумма", LS.Номер as 'Номер ЛЦ', KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID as 'ROW_ID_Организации', KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
LEFT JOIN (
    SELECT VZ.ROW_ID as 'ROW_ID_Взыскания', VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние', VZ.[Счет-Взыскания]
    FROM [Взыскание задолженности] VZ
    JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
    JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
    LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
    JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
    JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
    WHERE O.ИНН ='3444259579'
    AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7036, 7034))
) VZ ON Счет = VZ.[Счет-Взыскания]
WHERE NS.[Месяц расчета] = '2024-10-01' AND NS.[Месяц долга] >= '2024-10-01' and NS.[Сумма] > 0
AND O.ИНН ='3444259579'
AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7036, 7034))
GROUP BY LS.Номер, KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID, KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]
```
# Задание 6
- Проанализировать связи между таблицами Реестры и Лицевые счета
- Создать 3 запроса на выборку
    - Мунжилье
    - Цессии
    - Остальное
- Отфильтровать данные по Папкам и Категории организации
## Мунжилье
```rb
SELECT T.* FROM Реестры R 
JOIN #temp T ON T.[Номер ЛЦ] = R.[Реестры_состав-Лицевой]
JOIN [Категории организаций] KO ON KO.[Категории-Организация] = T.ROW_ID_Организации
WHERE R.Папки = 35700042 AND KO.[Категории организаций] = 7036
```
## Цессии
```rb
SELECT T.* FROM #temp T
JOIN [Категории организаций] KO ON KO.[Категории-Организация] = T.ROW_ID_Организации
WHERE KO.[Категории организаций] = 7034
```
## Остальное
```rb
SELECT T.* FROM #temp T
JOIN [Категории организаций] KO ON KO.[Категории-Организация] = T.ROW_ID_Организации
WHERE KO.[Категории организаций] = 7036 and T.[Счет-Наниматель] NOT IN (SELECT R.[Реестры_состав-Лицевой] FROM Реестры R WHERE R.Папки = 35700042)
```
# Результат выполнения ex1
```rb
drop table if EXISTS #tempVZ

SELECT VZ.ROW_ID as 'ROW_ID_Взыскания', VZ.Номер, CONCAT(VF.Название, ' ', SF.Имя) as 'Фаза + Состояние', VZ.[Счет-Взыскания], VZ.ДатНачДолга, VZ.ДатКнцДолга
into #tempVZ
FROM [Взыскание задолженности] VZ
JOIN [Состояние документа] SD ON SD.[Документ-Состояние] = VZ.ROW_ID
JOIN [Виды фаз] VF ON VF.ROW_ID = SD.[Фаза-Состояние]
LEFT JOIN [Состояния фаз] SF ON SF.[Состояние-Фаза] = VF.ROW_ID
JOIN [Держатели долга] DD ON DD.ROW_ID = VZ.[Держатели долга-Взыскания]
JOIN [Организации] O ON O.ROW_ID = DD.[Держатели-Организация]
WHERE  O.ИНН ='3444259579'
AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7036, 7034))
GROUP BY VZ.ROW_ID, VZ.Номер, VF.Название, SF.Имя,  VZ.[Счет-Взыскания], VZ.ДатНачДолга, VZ.ДатКнцДолга

drop table if EXISTS #tempNS

SELECT ROUND(SUM(NS.[Сумма]), 2) as "Сумма", LS.Номер as 'Номер ЛЦ', KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID as 'ROW_ID_Организации', 
KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]
into #tempNS
FROM [НСальдо] NS
JOIN [Лицевые счета] LS ON LS.ROW_ID = NS.[Счет]
JOIN [Организации] O ON O.ROW_ID = NS.Поставщик
JOIN [Карточки регистрации] KR ON KR.ROW_ID = LS.[Счет-Наниматель]
WHERE NS.[Месяц расчета] = '2024-10-01' AND NS.[Месяц долга] >= '2024-10-01' and NS.[Сумма] > 0
AND O.ИНН ='3444259579'
AND O.ROW_ID IN (SELECT KO.[Категории-Организация] FROM [Категории организаций] KO WHERE KO.[Категории организаций] IN (7036, 7034))
GROUP BY LS.Номер, KR.[Счет-Наниматель], NS.[Месяц долга], O.Наименование, O.ROW_ID, KR.ФИО, KR.[Дата рождения], KR.[Дата смерти]

SELECT * FROM #tempVZ VZ
Right JOIN #tempNS NS ON NS.[Счет-Наниматель] = VZ.[Счет-Взыскания] AND [Месяц долга] BETWEEN Vz.ДатНачДолга AND VZ.ДатКнцДолга
```